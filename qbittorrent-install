#!/bin/sh

set -e

QBIT_VERSION="4.5.2"
LIBTORRENT_VERSION="1.2.19"
ARCH=$(uname -m)

# === æ¶æ„åˆ¤æ–­ ===
if [ "$ARCH" = "x86_64" ]; then
    BINARY_URL="https://github.com/userdocs/qbittorrent-nox-static/releases/download/release-${QBIT_VERSION}_v${LIBTORRENT_VERSION}/x86_64-qt5-qbittorrent-nox"
elif echo "$ARCH" | grep -qE '^aarch64|armv7'; then
    echo "âš ï¸ æš‚ä¸æ”¯æŒ ARM æ¶æ„çš„é™æ€äºŒè¿›åˆ¶ä¸‹è½½é“¾æ¥ï¼Œè¯·æ‰‹åŠ¨æ›¿æ¢ BINARY_URLã€‚"
    exit 1
else
    echo "âŒ æœªçŸ¥æˆ–ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
    exit 1
fi

# === å®‰è£…å¿…è¦ä¾èµ– ===
apk add --no-cache bash wget curl shadow openrc su-exec

# === ç¡®è®¤ su-exec è·¯å¾„ ===
SUEXEC=$(which su-exec)

# === åˆ›å»ºç”¨æˆ·å’Œä¸‹è½½ç›®å½• ===
addgroup -S qbittorrent || true
adduser -S -G qbittorrent qbittorrent || true
mkdir -p /opt/qbittorrent /opt/qbittorrent/downloads
chown -R qbittorrent:qbittorrent /opt/qbittorrent

# === ä¸‹è½½ qBittorrent-nox é™æ€ç‰ˆæœ¬ ===
cd /opt/qbittorrent
wget -O qbittorrent-nox "$BINARY_URL"
chmod +x qbittorrent-nox
chown qbittorrent:qbittorrent qbittorrent-nox

# === åˆå§‹åŒ–é…ç½®ç›®å½•ï¼ˆ~/.config/qBittorrentï¼‰ ===
echo "ğŸ› ï¸ åˆå§‹åŒ–é…ç½®..."
$SUEXEC qbittorrent ./qbittorrent-nox & 
sleep 3
pkill -f qbittorrent-nox || true

# === åˆ›å»º OpenRC å¯åŠ¨æœåŠ¡ ===
cat << EOF > /etc/init.d/qbittorrent
#!/sbin/openrc-run

name="qbittorrent"
description="qBittorrent Daemon"

command="$SUEXEC"
command_args="qbittorrent /opt/qbittorrent/qbittorrent-nox"
command_background=true
pidfile="/run/\${RC_SVCNAME}.pid"

depend() {
    need net
    before local
}

start_pre() {
    checkpath --directory --mode 0755 /run/qbittorrent
}

stop_post() {
    rm -f /run/\${RC_SVCNAME}.pid
}
EOF

chmod +x /etc/init.d/qbittorrent
rc-update add qbittorrent default
rc-service qbittorrent start

sleep 1
rc-service qbittorrent status

# === æç¤ºè®¿é—®æ–¹å¼ ===
echo "âœ… qBittorrent å®‰è£…å®Œæˆ"
echo "ğŸ“ ä¸‹è½½ç›®å½•ï¼š/opt/qbittorrent/downloads"
echo "ğŸŒ Web ç•Œé¢ï¼šhttp://<ä½ çš„å…¬ç½‘IP>:8080"
echo "ğŸ” é»˜è®¤ç”¨æˆ·åï¼šadmin"
echo "ğŸ” é»˜è®¤å¯†ç ï¼šadminadmin"
