#!/bin/sh

set -e

# === åŸºæœ¬ä¿¡æ¯ ===
QBIT_VERSION="4.5.2"
LIBTORRENT_VERSION="1.2.19"
ARCH=$(uname -m)

# === æ¶æ„åˆ¤æ–­ ===
if [ "$ARCH" = "x86_64" ]; then
    BINARY_URL="https://github.com/userdocs/qbittorrent-nox-static/releases/download/release-${QBIT_VERSION}_v${LIBTORRENT_VERSION}/x86_64-qt5-qbittorrent-nox"
elif echo "$ARCH" | grep -qE '^aarch64|armv7'; then
    echo "âš ï¸ æš‚ä¸æ”¯æŒ ARM æ¶æ„çš„é™æ€äºŒè¿›åˆ¶ä¸‹è½½é“¾æ¥ï¼Œè¯·æ‰‹åŠ¨æ›¿æ¢ BINARY_URLã€‚"
    exit 1
else
    echo "âŒ æœªçŸ¥æˆ–ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
    exit 1
fi

# === Alpine ç‰ˆæœ¬æ£€æŸ¥ ===
ALPINE_VERSION=$(cat /etc/alpine-release)
echo "ğŸ“¦ å½“å‰ Alpine ç‰ˆæœ¬ä¸º: $ALPINE_VERSION"

MIN_VER="3.16"
MAX_VER="3.20"

apk_version_supported() {
    ver=$(printf "%s\n%s\n" "$1" "$2" | sort -V | head -n1)
    [ "$ver" = "$1" ]
}

if apk_version_supported "$MIN_VER" "$ALPINE_VERSION" && apk_version_supported "$ALPINE_VERSION" "$MAX_VER"; then
    echo "âœ… Alpine ç‰ˆæœ¬å…¼å®¹"
else
    echo "âš ï¸ æ³¨æ„ï¼šè„šæœ¬å»ºè®®åœ¨ Alpine $MIN_VER - $MAX_VER ä½¿ç”¨ï¼Œå½“å‰ç‰ˆæœ¬æœªå®Œå…¨æµ‹è¯•"
fi

# === å®‰è£…å¿…è¦ä¾èµ– ===
echo "ğŸ“¥ å®‰è£…å¿…è¦ä¾èµ–..."
apk add --no-cache bash wget curl shadow openrc su-exec

# === åˆ›å»ºç”¨æˆ·å’Œä¸‹è½½ç›®å½• ===
echo "ğŸ‘¤ åˆ›å»º qbittorrent ç”¨æˆ·å’Œä¸‹è½½ç›®å½•..."
addgroup -S qbittorrent
adduser -S -G qbittorrent qbittorrent
mkdir -p /root/Downloads
chown qbittorrent:qbittorrent /root/Downloads
chmod 777 /root/Downloads

# === ä¸‹è½½ qBittorrent-nox é™æ€ç‰ˆæœ¬ ===
echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ qBittorrent-nox..."
cd /root
wget -O qbittorrent-nox "$BINARY_URL"
chmod +x qbittorrent-nox
chown qbittorrent:qbittorrent qbittorrent-nox

# === è¿è¡Œä¸€æ¬¡ä»¥ç”Ÿæˆé…ç½®ç›®å½• ===
echo "ğŸ› ï¸ åˆå§‹åŒ–é…ç½®..."
su-exec qbittorrent /root/qbittorrent-nox & 
sleep 3
pkill -f qbittorrent-nox || true

# === åˆ›å»º OpenRC å¯åŠ¨æœåŠ¡ ===
echo "ğŸ”§ åˆ›å»º OpenRC æœåŠ¡..."
cat << EOF > /etc/init.d/qbittorrent
#!/sbin/openrc-run

name="qbittorrent"
description="qBittorrent Daemon"

command="/bin/su-exec"
command_args="qbittorrent /root/qbittorrent-nox"
command_background=true
pidfile="/run/\${RC_SVCNAME}.pid"

depend() {
    need net
    before local
}

start_pre() {
    checkpath --directory --mode 0755 /run/qbittorrent
}

stop_post() {
    rm -f /run/\${RC_SVCNAME}.pid
}
EOF

chmod +x /etc/init.d/qbittorrent
rc-update add qbittorrent default
rc-service qbittorrent start

sleep 1
rc-service qbittorrent status

# === æç¤ºç”¨æˆ·è®¿é—®æ–¹å¼ ===
echo "âœ… qBittorrent å·²æˆåŠŸå®‰è£…å’Œé…ç½®"
echo "ğŸŒ è¯·è®¿é—®ï¼š http://<ä½ çš„å…¬ç½‘IP>:8080"
echo "ğŸ” é»˜è®¤ç”¨æˆ·åï¼šadmin"
echo "ğŸ” é»˜è®¤å¯†ç ï¼šadminadmin"
